---
title: "Reading and Summarizing JSON Data"
author: "Avy Harvey"
date: "6/2/2020"
output:
  html_document:
    toc: true
#output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

This goal of this vignette is to show how to read and summarize a JSON data set in R. The JSON data used in the examples is from the National Hockey League REST API.

## JSON 101

**JSON** (JavaScript Object Notation) is a text-based, lightweight, structured data format that's easy to read and write. It's also easy for computers to read and write! JSON is a very common format used by web-based APIs (i.e., REST APIs) to transfer data between a client and server, and is used to store data in some popular NoSQL databases, such as MongoDB.

The beauty of the JSON format is in its simplicity. The main building block of JSON data is the **name-value pair** (also called key-value pairs). JSON **objects** are made up of zero or more name-value pairs. We'll be working with NHL data, so let's describe the Carolina Hurricanes NHL franchise using the JSON format. JSON objects start with `{` and end with `}`. In between, we can specify name-value pairs, such as `name: "Carolina Hurricanes"`, or `city: "Raleigh"`. Let's combine these ideas to start describing the Carolina Hurricanes as a JSON object:

```
{
  name: "Carolina Hurricanes",
  city: "Raleigh"
}
```

You may notice that the two name-value pairs above are separated by a comma (`,`) character. This is how the JSON format is able to tell when one name-value pair ends and another begins. The whitespace (e.g., spaces, line breaks) doesn't matter, but it can make the data easier for humans to read.

Something important to note is that JSON only allows a name to exist at most once within an object. This is something that helps make JSON readable for humans and machines -- if you want to find a name in an object, you can be assured that at most one will exist. Adding a second `city: "Raleigh"` or `city: "Somewhere Else"` pair to the object would be invalid.

In the example so far, I've only used strings as values: "Carolina Hurricanes" and "Raleigh". However, JSON allows for many different types of values: strings, numbers, dates, arrays (we'll get to those), and even other objects! Here's an example that illustrates some of these types:

```
{
  name: "Carolina Hurricanes",
  location: {
    city: "Raleigh",
    state: "NC",
  },
  num_notable_players: 2,
  notable_players: ["Ron Francis", "Rod Brind'Amour"]
}
```

Now that we see how JSON objects are formed, let's talk about **arrays**. JSON arrays are lists of items. These items can be anything a JSON value can be: strings, numbers, dates, arrays, or objects. In the above example, the value of the`notable_players` key is an array of strings. When querying REST APIs, you'll likely encounter arrays frequently.

Why someone would choose to store their data in JSON format? Here are a few reasons:

- Easy to read and write
- Data relationships can be nested in the document itself (as opposed to typical RDBMS schemas)
- Lightweight textual data transfer
- Parsing/writing supported by many programming languages

These resources provide additional description and examples of JSON:

* https://www.json.org/json-en.html
* https://www.w3schools.com/js/js_json_intro.asp
* https://www.infoworld.com/article/3222851/what-is-json-a-better-format-for-data-exchange.html

## Reading JSON in R

### Packages

Now that you know the basics of JSON, how can JSON data be read in R?

There are three major packages for handling JSON data:

* rjson
* RJSONIO
* jsonlite

[This page](https://rstudio-pubs-static.s3.amazonaws.com/31702_9c22e3d1a0c44968a4a1f9656f1800ab.html) shows some examples of using each of the above packages to compare behaviors, and also provides some performance metrics for parsing and writing JSON.

Each of the above packages can parse and write JSON (though each one has its own nuances). The respective methods are named `fromJSON` and `toJSON` in each package. RJSONIO and jsonlite seem to be more full-featured than rjson when it comes to prettifying (inserting whitespace to make JSON more readable for humans) and simplification. rjson is has the fastest performance of the three packages, with RJSONIO being the slowest (by far).

I'll be using jsonlite in the rest of this vignette since it is more full-featured than rjson and better performing than RJSONIO. However, you can probably adapt my examples to either of the other two packages if you like.

### Consuming JSON from the NHL's REST API

After installing the jsonlite and httr packages with `install.packages(c("jsonlite", "httr"))`, let's read some data!

First, load the libraries:

```{r, message = FALSE}
library(jsonlite)
library(httr)
```

The base URL where we will be pulling this data from is `https://records.nhl.com/site/api`. All retrievals are HTTP `GET` requests.

The following functions can be used to retrieve and parse data from the respective endpoints:

#### Franchises

Gets the list of NHL franchises from the `/franchise` endpoint.

Returns a tibble with `id`, `firstSeasonId`, `lastSeasonId`, and `name` of every team in the history of the NHL.

```{r}
get_franchises <- function() {
  base_url <- "https://records.nhl.com/site/api"
  
  # Get the list of NHL franchises
  response <- GET(url = paste0(base_url, "/franchise")) %>%
    content(as = "text", encoding = "UTF-8") %>%
    fromJSON()
  
  # Get the data attribute from the JSON object
  as_tibble(response$data)
}

# Example usage
get_franchises()
```

#### Franchise Team Statistics

Gets franchise team total statistics from the `franchise-team-totals` endpoint.

Returns a tibble of total statistics for every franchise (e.g., `roadTies`, `roadWins`, etc.).

```{r}
get_franchise_stats <- function() {
  base_url <- "https://records.nhl.com/site/api"
  
  # Get the list of NHL franchises
  response <- GET(url = paste0(base_url, "/franchise-team-totals")) %>%
    content(as = "text", encoding = "UTF-8") %>%
    fromJSON()
  
  # Get the data attribute from the JSON object
  as_tibble(response$data)
}

# Example usage
get_franchise_stats()
```

#### Season Records by Franchise

Gets season records for a specific franchise from the `franchise-season-records` endpoint.

Expects a franchise ID to be provided.

Returns a tibble of the season records for the franchise associated with the provided franchise ID.

```{r}
get_season_records_by_franchise <- function(franchise_id) {
  base_url <- "https://records.nhl.com/site/api"
  
  # Get the list of NHL franchises
  response <- GET(url = paste0(base_url, "/franchise-season-records?cayenneExp=franchiseId=", franchise_id)) %>%
    content(as = "text", encoding = "UTF-8") %>%
    fromJSON()
  
  # Get the data attribute from the JSON object
  as_tibble(response$data)
}

# Example usage ('26' is the franchise ID for the Carolina Hurricanes)
get_season_records_by_franchise(26)
```

#### Goalie Records by Franchise

Gets goalie records for a specific franchise from the `franchise-goalie-records` endpoint.

Expects a franchise ID to be provided.

Returns a tibble of the goalie records for the franchise associated with the provided franchise ID.

```{r}
get_goalie_records_by_franchise <- function(franchise_id) {
  base_url <- "https://records.nhl.com/site/api"
  
  # Get the list of NHL franchises
  response <- GET(url = paste0(base_url, "/franchise-goalie-records?cayenneExp=franchiseId=", franchise_id)) %>%
    content(as = "text", encoding = "UTF-8") %>%
    fromJSON()
  
  # Get the data attribute from the JSON object
  as_tibble(response$data)
}

# Example usage ('26' is the franchise ID for the Carolina Hurricanes)
get_goalie_records_by_franchise(26)
```

#### Skater Records by Franchise

Gets skater records for a specific franchise from the `franchise-skater-records` endpoint.

Expects a franchise ID to be provided.

Returns a tibble of the skater records for the franchise associated with the provided franchise ID.

```{r}
get_skater_records_by_franchise <- function(franchise_id) {
  base_url <- "https://records.nhl.com/site/api"
  
  # Get the list of NHL franchises
  response <- GET(url = paste0(base_url, "/franchise-skater-records?cayenneExp=franchiseId=", franchise_id)) %>%
    content(as = "text", encoding = "UTF-8") %>%
    fromJSON()
  
  # Get the data attribute from the JSON object
  as_tibble(response$data)
}

# Example usage ('26' is the franchise ID for the Carolina Hurricanes)
get_skater_records_by_franchise(26)
```

## Summarizing Data

Once you have the functions to query the data, you should perform a basic exploratory data analysis.
Not all things reported need to show something interesting or meaningful (i.e. graphs that show no
relationship are fine) but you should discuss each graph (if you don’t know hockey, that is ok - simply
discuss the graphs and summaries as best you can). A few requirements are below:

– You should create a new variable at some point
– You should create some contingency tables and numeric summaries by some of your categorical variables
– You should create some plots (at least a side-by-side bar plot, side-by-side box plots, and scatterplots with coloring)

### Numeric Summaries

#### Active Player Positions by Team (Metro Division)

Q: How have teams in the Metropolitan divison allocated their current rosters with respect to skaters?

```{r}
# Helper function to look up franchise IDs by team common name
get_franchise_id_by_name <- function(franchise_common_name) {
  get_franchises() %>%
    filter(is.na(lastSeasonId) & teamCommonName == franchise_common_name) %>%
    select(id) %>%
    pull()
}

# Teams in the Metro division
metro_division_names = c("Capitals", "Penguins", "Rangers", "Flyers", 
                         "Islanders", "Devils", "Blue Jackets", "Hurricanes")

# IDs of the Metro teams
metro_division_ids <- sapply(metro_division_names, get_franchise_id_by_name)

# Get the skater records for all Metro teams
metro_skaters_tbl <- lapply(metro_division_ids, get_skater_records_by_franchise) %>%
  bind_rows()

# We only want active players in this report
metro_skaters_tbl %>%
  filter(activePlayer == TRUE) %>%
  select(franchiseName, positionCode) %>%
  table(dnn = c("Franchise Name", "Position")) %>%
  addmargins() %>%
  knitr::kable(caption = "Player Positions by Franchise")
```

The contingency table above shows the positions of all the active players for the respective franchises. Note this data includes players who played an NHL game but may now be playing in a minor league affliate (e.g., AHL or EHCL) of the franchise, since an NHL active roster can only have 23 players. From this table, I noticed a few things:

* Most teams are loaded with centermen (particularly the Columbus Blue Jackets and Pittsburgh Penguins)
* Overall, these teams invest in more left wings than right wings
* The Washington Capitals and NY Islanders don't have to pull in as many minor-league reserves as other teams
  * This difference mostly appears to be with the number of centermen
* The Carolina Hurricanes have the fewest skaters at any one position with just 6 right wings

#### Player Position vs. Tenure with Carolina

Q: Is there a relationship between a player's position and the number of seasons they spent with the Carolina Hurricanes?

```{r}
# '26' is the franchise ID for the Carolina Hurricanes
carolina_skater_records <- get_skater_records_by_franchise(26)

carolina_skater_records %>%
  select(positionCode, seasons) %>%
  mutate(seasons = factor(case_when(  # Bin the seasons to make it a categorical variable
    seasons >= 10 ~ ">= 10",
    seasons >= 6 ~ "6-9",
    seasons >= 3 ~ "3-5",
    seasons < 3 ~ "< 3"
  ), levels = c("< 3", "3-5", "6-9", ">= 10"))) %>%
  mutate(positionCode = case_when(  # Rename the positions for readability
    positionCode == "C" ~ "Center",
    positionCode == "L" ~ "Left Wing",
    positionCode == "R" ~ "Right Wing",
    positionCode == "D" ~ "Defenseman"
  )) %>%
  table(dnn = c("Position", "Number of Seasons")) %>%  # Create a contingency table
  addmargins() %>%  # Add column and row totals to the contingency table
  knitr::kable(caption = "Number of Seasons with Carolina Hurricanes by Player Position")
```

From the contingency table above, we can see that proportionally, skaters who play Right Wing are most likely to have short careers with the Carolina Hurricanes. Those who play Left Wing or Center ore most likely to have longer careers with the Hurricanes. The number of defensemen is higher than the other positions across most of the categories, but this is likely because there are usually two defensemen in a lineup, to go along with the three forwards (center, left and right wings), and the goalie. Very few players have spent more than 10 seasons with the Hurricanes.

#### Most Penalized Teams

Q: What are the top 10 active teams that have been penalized the most in the regular season?

```{r}
franchises <- get_franchises()
franchise_stats <- get_franchise_stats()

penalized_stats <-
  franchise_stats %>%
  filter(gameTypeId == 2 & is.na(lastSeasonId)) %>%  # Regular season only
  # New variable: penalty minutes per game
  mutate(avgPenaltyMinutesPerGame = penaltyMinutes / gamesPlayed) %>%
  arrange(desc(avgPenaltyMinutesPerGame)) %>%
  select(teamName, avgPenaltyMinutesPerGame)

penalized_stats %>%
  head(10) %>%
  knitr::kable(col.names = c("Team Name", "Average Penalty Minutes Per Game"))
```

In the above example, I've computed the average number of penalty minutes per game for the currently active NHL teams. It's interesting to see how the top five teams are composed of the two Pennsylvania teams and three Canadian teams! The Flyers are in a class of their own when it comes to average penalty minutes. One thing this data does not show is when (i.e., what season) those penalty minutes were given; it would be interesting to see that data broken down by year so we could see the shape of the distribution. 

```{r}
# Quartile functions
q1 <- function(x) { quantile(x, 0.25)[[1]] }
q3 <- function(x) { quantile(x, 0.75)[[1]] }

penalized_stats %>%
  select(avgPenaltyMinutesPerGame) %>%
  summarise_all(list("Min." = min,
                     "1st Qu." = q1,
                     "Median" = median,
                     "Mean" = mean,
                     "3rd Qu." = q3,
                     "Max" = max,
                     "Standard Dev." = sd)) %>%
  knitr::kable(caption = "Summary of Average Penalty Minutes Per Game")
```

I created a quick summary of this variable to try to understand the distribution of average penalty minutes per game across the league, to see if the top ten teams were far and away the worst offenders. I did not find this to to be the case -- the data seems to be just slightly skewed left based on the numeric summary.


~~Q: Which has been the best franchise in the Metropolitan Division over the past five seasons?~~

~~Q: Which team has the best active goalie in the Metropolitan Division (by win percentage)?~~

### Graphical Summaries

Q: Is there a relationship between a skater's position and the number of goals they score? What about assists? (side-by-side bar plot)

Q: Is there a relationship between how many assists a skater has and how many goals they score, by position? (scatterplot)

Q: Which team has the best offense in the Metropolitan Division? (boxplot)

